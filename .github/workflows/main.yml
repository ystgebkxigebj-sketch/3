name: Gartic RDP (Win10 + Max Virtual RAM)
on:
  workflow_dispatch:

jobs:
  gartic-bot:
    runs-on: windows-2019
    timeout-minutes: 360

    steps:
      - name: 1. Maximize Virtual Memory (The Trick)
        run: |
          Set-ItemProperty -Path 'HKLM:\SYSTEM\CurrentControlSet\Control\Session Manager\Memory Management' -Name "PagingFiles" -Value "C:\pagefile.sys 20000 20000"
          Write-Host "Virtual Memory Increased to 20GB!"

      - name: 2. Configure RDP Network
        run: |
          Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server' -Name "fDenyTSConnections" -Value 0 -Force
          Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server\WinStations\RDP-Tcp' -Name "UserAuthentication" -Value 0 -Force
          netsh advfirewall firewall add rule name="Allow-RDP" dir=in action=allow protocol=TCP localport=3389

      - name: 3. Configure Extensions Policy
        run: |
          $firefoxDir = "C:\Program Files\Mozilla Firefox"
          $distDir = "$firefoxDir\distribution"
          if (!(Test-Path $distDir)) { New-Item -ItemType Directory -Force -Path $distDir }

          $extensions = @(
              "https://addons.mozilla.org/firefox/downloads/latest/ublock-origin/latest.xpi",
              "https://addons.mozilla.org/firefox/downloads/latest/violentmonkey/latest.xpi"
          )

          $policies = @{
              policies = @{
                  Extensions = @{ Install = $extensions }
                  DisableAppUpdate = $true
                  DontCheckDefaultBrowser = $true
              }
          }
          $policies | ConvertTo-Json -Depth 4 | Out-File "$distDir\policies.json" -Encoding UTF8
          Write-Host "Extension policy set."

      - name: 4. Create RDP User
        run: |
          $password = "Start@123456"
          $securePass = ConvertTo-SecureString $password -AsPlainText -Force
          New-LocalUser -Name "YOU" -Password $securePass -AccountNeverExpires -ErrorAction SilentlyContinue
          Add-LocalGroupMember -Group "Administrators" -Member "YOU"
          Add-LocalGroupMember -Group "Remote Desktop Users" -Member "YOU"

      - name: 5. Start Tailscale
        run: |
          $tsUrl = "https://pkgs.tailscale.com/stable/tailscale-setup-latest.exe"
          Invoke-WebRequest -Uri $tsUrl -OutFile "$env:TEMP\tailscale.exe"
          Start-Process "$env:TEMP\tailscale.exe" -ArgumentList "/quiet", "/norestart" -Wait
          & "C:\Program Files\Tailscale\tailscale.exe" up --authkey=${{ secrets.TAILSCALE_AUTH_KEY }} --hostname=gartic-max-ram

      - name: 6. Create 3 Firefox Profiles + Install Userscript
        run: |
          $ip = & "C:\Program Files\Tailscale\tailscale.exe" ip -4
          echo "::notice title=RDP CONNECT INFO::IP: $ip | User: YOU | Pass: Start@123456"

          $firefox = "C:\Program Files\Mozilla Firefox\firefox.exe"

          # Save the userscript
          $userscript = @'
          // ==UserScript==
          // @name         Gartic.io Token Fetcher (RDP Auto)
          // @namespace    http://tampermonkey.net/
          // @version      3.0
          // @description  Fetch maximum tokens from Turnstile with auto reload
          // @author       You
          // @match        *://gartic.io/*
          // @match        *://*.gartic.io/*
          // @grant        none
          // ==/UserScript==
          (function () {
              'use strict';
              const TOKEN_INTERVAL = 4000;
              const NUM_IFRAMES = 6;
              const BACKEND_URL = 'https://moonfive.alwaysdata.net/add-token';
              setInterval(() => { location.reload(); }, 30000);
              function sendToken(token) {
                  if (typeof token !== 'string' || token.length <= 20) return;
                  fetch(BACKEND_URL, {
                      method: 'POST',
                      headers: { 'Content-Type': 'application/json' },
                      body: JSON.stringify({ token })
                  }).catch(() => {});
              }
              function createTurnstileFrames() {
                  window.addEventListener('message', function(event) {
                      if (event.data && typeof event.data === 'string') {
                          sendToken(event.data);
                      }
                  });
                  for (let i = 0; i < NUM_IFRAMES; i++) {
                      const iframe = document.createElement('iframe');
                      iframe.style.display = 'none';
                      iframe.sandbox = 'allow-scripts allow-same-origin';
                      document.body.appendChild(iframe);
                      iframe.srcdoc = '<!DOCTYPE html><html><head><script src="https://challenges.cloudflare.com/turnstile/v0/api.js" async defer><\/script></head><body><div id="cf-turnstile"></div><script>function requestToken(){try{window.turnstile.render("#cf-turnstile",{sitekey:"0x4AAAAAABBPKaIbNwnPEfSo",callback:function(token){parent.postMessage(token,"*")}});}catch(e){}}setInterval(requestToken,4000);setTimeout(requestToken,200);<\/script></body></html>';
                  }
              }
              createTurnstileFrames();
          })();
          '@
          $userscript | Out-File "C:\gartic.user.js" -Encoding UTF8
          Write-Host "Userscript saved to C:\gartic.user.js"

          # Create 3 separate Firefox profiles
          $profileNames = @("token1", "token2", "token3")

          foreach ($name in $profileNames) {
              Write-Host ""
              Write-Host "Creating profile: $name"
              
              # Create the profile
              Start-Process $firefox -ArgumentList "-CreateProfile", "$name" -Wait
              Start-Sleep -Seconds 2

              # Launch it headless to initialize extensions
              Write-Host "  Initializing $name (installing extensions)..."
              $proc = Start-Process $firefox -ArgumentList "-P", $name, "-headless", "-no-remote" -PassThru
              Start-Sleep -Seconds 25
              Stop-Process -Id $proc.Id -Force -ErrorAction SilentlyContinue
              Start-Sleep -Seconds 3
              Write-Host "  Profile $name initialized."
          }

          # Find all profile paths and log them
          $profilesDir = "$env:APPDATA\Mozilla\Firefox\Profiles"
          Write-Host ""
          Write-Host "All profiles:"
          Get-ChildItem $profilesDir -Directory | ForEach-Object { Write-Host "  $($_.Name)" }

          # Create START-GARTIC.bat
          $batContent = @'
          @echo off
          title Gartic Token Farm
          color 0A
          echo.
          echo  ========================================
          echo   GARTIC TOKEN FARM  (3 Profiles)
          echo  ========================================
          echo.
          echo  Step 1: Installing userscript in each profile...
          echo  ViolentMonkey will pop up 3 times.
          echo  Click CONFIRM INSTALLATION each time.
          echo.

          set FIREFOX="C:\Program Files\Mozilla Firefox\firefox.exe"

          start "" %FIREFOX% -P "token1" -no-remote "file:///C:/gartic.user.js"
          timeout /t 3 /nobreak >nul
          start "" %FIREFOX% -P "token2" -no-remote "file:///C:/gartic.user.js"
          timeout /t 3 /nobreak >nul
          start "" %FIREFOX% -P "token3" -no-remote "file:///C:/gartic.user.js"

          echo.
          echo  Click CONFIRM in all 3 ViolentMonkey popups.
          echo  Then press any key to continue...
          pause >nul

          echo.
          echo  Step 2: Opening gartic.io in each profile...
          echo.

          start "" %FIREFOX% -P "token1" -no-remote "https://gartic.io/"
          timeout /t 2 /nobreak >nul
          start "" %FIREFOX% -P "token2" -no-remote "https://gartic.io/"
          timeout /t 2 /nobreak >nul
          start "" %FIREFOX% -P "token3" -no-remote "https://gartic.io/"

          echo.
          echo  ========================================
          echo   DONE!
          echo  ========================================
          echo.
          echo   3 Firefox windows running.
          echo   Each has its own profile (isolated cookies).
          echo   Userscript runs on each.
          echo   Tokens flow automatically.
          echo   Each tab reloads every 30 seconds.
          echo.
          echo   You can minimize the Firefox windows.
          echo.
          pause
          '@

          $batContent | Out-File "C:\Users\Public\Desktop\START-GARTIC.bat" -Encoding ASCII
          $youDesktop = "C:\Users\YOU\Desktop"
          if (!(Test-Path $youDesktop)) { New-Item -ItemType Directory -Force -Path $youDesktop }
          $batContent | Out-File "$youDesktop\START-GARTIC.bat" -Encoding ASCII

          Write-Host ""
          Write-Host "=========================================="
          Write-Host "SETUP COMPLETE!"
          Write-Host "  3 Firefox profiles created: token1, token2, token3"
          Write-Host "  Userscript at C:\gartic.user.js"
          Write-Host "  START-GARTIC.bat on desktop"
          Write-Host "=========================================="

          while ($true) { Start-Sleep -Seconds 300 }
